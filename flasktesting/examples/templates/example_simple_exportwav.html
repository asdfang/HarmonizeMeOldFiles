<!DOCTYPE html>

<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>Sing and Harmonize!</title>
   <script src="/static/jquery-3.2.1.min.js"></script>
   <link rel="stylesheet" type="text/css" href="../static/bootstrap-3.3.7-dist/css/bootstrap.min.css">
   <script src="../static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.0.52/wavesurfer.min.js"></script>
   <script src="/static/dist/recorder.js"></script>
   <style type='text/css'>
      ul { list-style: none; }
      #recordingslist audio { display: block; margin-bottom: 10px; }
      * {
            -webkit-user-select: none;
         }
         body, html {
            margin: 0;
            height: 100%;
            position: relative;
         }
         body {
            padding-top: 70px;
            overflow: auto;
            background-color: lightblue;
         }
         h1 {
            text-align: center;
         }
         td {
            padding-top:5px;
            padding-bottom:5px;
            padding-right:10px;
         }
         li {
            text-align: center;
         }
         br {
            line-height: 150%;
         }
         .btn-xlarge {
            padding: 18px 28px;
            font-size: 22px;
            line-height: normal;
            -webkit-border-radius: 8px;
               -moz-border-radius: 8px;
                  border-radius: 8px;
         }
         .btn-space {
            margin-left: 1px;
            margin-right: 1px;
         }
   </style>
</head>
<body>
   <div id="audio_list">
         <!-- audio tonic files -->
         <audio id="60Majorhigh.mp3" src="./resources/60Majorhigh.mp3" preload="auto"></audio>
         <audio id="60Majormid.mp3"  src="./resources/60Majormid.mp3" preload="auto"></audio>
         <audio id="60Minorhigh.mp3" src="./resources/60Minorhigh.mp3" preload="auto"></audio>
         <audio id="60Minormid.mp3"  src="./resources/60Minormid.mp3" preload="auto"></audio>

         <audio id="61Majorhigh.mp3" src="./resources/61Majorhigh.mp3" preload="auto"></audio>
         <audio id="61Majormid.mp3"  src="./resources/61Majormid.mp3" preload="auto"></audio>
         <audio id="61Minorhigh.mp3" src="./resources/61Minorhigh.mp3" preload="auto"></audio>
         <audio id="61Minormid.mp3"  src="./resources/61Minormid.mp3" preload="auto"></audio>

         <audio id="62Majorhigh.mp3" src="./resources/62Majorhigh.mp3" preload="auto"></audio>
         <audio id="62Majormid.mp3"  src="./resources/62Majormid.mp3" preload="auto"></audio>
         <audio id="62Minorhigh.mp3" src="./resources/62Minorhigh.mp3" preload="auto"></audio>
         <audio id="62Minormid.mp3"  src="./resources/62Minormid.mp3" preload="auto"></audio>

         <audio id="63Majorhigh.mp3" src="./resources/63Majorhigh.mp3" preload="auto"></audio>
         <audio id="63Majormid.mp3"  src="./resources/63Majormid.mp3" preload="auto"></audio>
         <audio id="63Majorlow.mp3"  src="./resources/63Majorlow.mp3" preload="auto"></audio>
         <audio id="63Minorhigh.mp3" src="./resources/63Minorhigh.mp3" preload="auto"></audio>
         <audio id="63Minormid.mp3"  src="./resources/63Minormid.mp3" preload="auto"></audio>
         <audio id="63Minorlow.mp3"  src="./resources/63Minorlow.mp3" preload="auto"></audio>

         <audio id="64Majorhigh.mp3" src="./resources/64Majorhigh.mp3" preload="auto"></audio>
         <audio id="64Majormid.mp3"  src="./resources/64Majormid.mp3" preload="auto"></audio>
         <audio id="64Majorlow.mp3"  src="./resources/64Majorlow.mp3" preload="auto"></audio>
         <audio id="64Minorhigh.mp3" src="./resources/64Minorhigh.mp3" preload="auto"></audio>
         <audio id="64Minormid.mp3"  src="./resources/64Minormid.mp3" preload="auto"></audio>
         <audio id="64Minorlow.mp3"  src="./resources/64Minorlow.mp3" preload="auto"></audio>

         <audio id="65Majorhigh.mp3" src="./resources/65Majorhigh.mp3" preload="auto"></audio>
         <audio id="65Majormid.mp3"  src="./resources/65Majormid.mp3" preload="auto"></audio>
         <audio id="65Majorlow.mp3"  src="./resources/65Majorlow.mp3" preload="auto"></audio>
         <audio id="65Minorhigh.mp3" src="./resources/65Minorhigh.mp3" preload="auto"></audio>
         <audio id="65Minormid.mp3"  src="./resources/65Minormid.mp3" preload="auto"></audio>
         <audio id="65Minorlow.mp3"  src="./resources/65Minorlow.mp3" preload="auto"></audio>

         <audio id="66Majorhigh.mp3" src="./resources/66Majorhigh.mp3" preload="auto"></audio>
         <audio id="66Majormid.mp3"  src="./resources/66Majormid.mp3" preload="auto"></audio>
         <audio id="66Majorlow.mp3"  src="./resources/66Majorlow.mp3" preload="auto"></audio>
         <audio id="66Minorhigh.mp3" src="./resources/66Minorhigh.mp3" preload="auto"></audio>
         <audio id="66Minormid.mp3"  src="./resources/66Minormid.mp3" preload="auto"></audio>
         <audio id="66Minorlow.mp3"  src="./resources/66Minorlow.mp3" preload="auto"></audio>

         <audio id="67Majorhigh.mp3" src="./resources/67Majorhigh.mp3" preload="auto"></audio>
         <audio id="67Majormid.mp3"  src="./resources/67Majormid.mp3" preload="auto"></audio>
         <audio id="67Majorlow.mp3"  src="./resources/67Majorlow.mp3" preload="auto"></audio>
         <audio id="67Minorhigh.mp3" src="./resources/67Minorhigh.mp3" preload="auto"></audio>
         <audio id="67Minormid.mp3"  src="./resources/67Minormid.mp3" preload="auto"></audio>
         <audio id="67Minorlow.mp3"  src="./resources/67Minorlow.mp3" preload="auto"></audio>

         <audio id="68Majorhigh.mp3" src="./resources/68Majorhigh.mp3" preload="auto"></audio>
         <audio id="68Majormid.mp3"  src="./resources/68Majormid.mp3" preload="auto"></audio>
         <audio id="68Majorlow.mp3"  src="./resources/68Majorlow.mp3" preload="auto"></audio>
         <audio id="68Minorhigh.mp3" src="./resources/68Minorhigh.mp3" preload="auto"></audio>
         <audio id="68Minormid.mp3"  src="./resources/68Minormid.mp3" preload="auto"></audio>
         <audio id="68Minorlow.mp3"  src="./resources/68Minorlow.mp3" preload="auto"></audio>

         <audio id="69Majorhigh.mp3" src="./resources/69Majorhigh.mp3" preload="auto"></audio>
         <audio id="69Majormid.mp3"  src="./resources/69Majormid.mp3" preload="auto"></audio>
         <audio id="69Majorlow.mp3"  src="./resources/69Majorlow.mp3" preload="auto"></audio>
         <audio id="69Minorhigh.mp3" src="./resources/69Minorhigh.mp3" preload="auto"></audio>
         <audio id="69Minormid.mp3"  src="./resources/69Minormid.mp3" preload="auto"></audio>
         <audio id="69Minorlow.mp3"  src="./resources/69Minorlow.mp3" preload="auto"></audio>

         <audio id="70Majorlow.mp3"  src="./resources/70Majorlow.mp3" preload="auto"></audio>
         <audio id="70Majormid.mp3"  src="./resources/70Majormid.mp3" preload="auto"></audio>
         <audio id="70Minorlow.mp3"  src="./resources/70Minorlow.mp3" preload="auto"></audio>
         <audio id="70Minormid.mp3"  src="./resources/70Minormid.mp3" preload="auto"></audio>

         <audio id="71Majorlow.mp3"  src="./resources/71Majorlow.mp3" preload="auto"></audio>
         <audio id="71Majormid.mp3"  src="./resources/71Majormid.mp3" preload="auto"></audio>
         <audio id="71Minorlow.mp3"  src="./resources/71Minorlow.mp3" preload="auto"></audio>
         <audio id="71Minormid.mp3"  src="./resources/71Minormid.mp3" preload="auto"></audio>
      </div>

   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-header">
         <a href="#" class="navbar-brand"><span class="glyphicon glyphicon-music" aria-hidden="true"></span> HarmonizeMe</a>
      </div>
   </nav>


   <div class="container">
      <h1>Record and sing!</h1>

      <div class="jumbotron">
         <p style="font-size:14px; text-align:center;">Use a recent version of Google Chrome.<br>
                        Before you enable microphone input, plug in headphones or turn the volume down to avoid loud feedback!</p>
         <h3 style="text-align:center;">Instructions:</h3>
         <p style="font-size:16px; text-align:center;">
            "Record" begins recording, so start singing loudly! "Pause" lets you stop and continue recording later. <br>
            "Stop" lets you completely stop and start over if needed. If you're satisfied, press "Harmonize Me!" <br>
         </p> 

         <div id="recordingButtons" style="text-align:center">
            <button id="recordButton" class="btn btn-info btn-space" onclick="startRecording(this);"><span class="glyphicon glyphicon-record" aria-hidden="true"></span> Record</button>
            <button class="btn btn-info btn-space" onclick="pauseRecording(this);" disabled><span class="glyphicon glyphicon-pause" aria-hidden="true"></span> Pause</button>
            <button class="btn btn-info btn-space" onclick="stopRecording(this);" style="margin-right:64px" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button>
            <!-- <button class="btn btn-primary" onclick="harmonize(this);">Harmonize!!</button> <br><br> -->
            <!-- testing: -->
            <a id="harmonized_results_link" href="{{ url_for('harmonizedResults') }}" class="btn btn-primary btn-xlarge disabled">Harmonize Me!!</a> 

            <br> <br>
            <!-- hidden at first -->
            <p id="playRecordedInstructions" style="font-size:16px; text-align:center; display:none">
               Listen to what you just recorded/uploaded below! You are free to re-record/re-upload if you would like.
            </p>
            <div id="waveform"></div> <br>
            <div style="text-align:center">
               <button id="playButton" class="btn btn-info btn-space" onclick="play(this);" style="display:none"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Play</button>
               <button class="btn btn-info btn-space" onclick="pause(this);" style="display:none" disabled><span class="glyphicon glyphicon-pause" aria-hidden="true"></span> Pause</button>
               <button class="btn btn-info btn-space" onclick="stop(this);" style="display:none" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button>
            </div>

         </div>
         <br>
         <!-- TESTING UPLOADING START -->
         <div class="form-group" id="upload" style="text-align:center">
            <p align="center">OR, upload a file if you have already recorded one before!</p>

            {% if not session.file_uploaded %}
            <form action="http://127.0.0.1:5000/uploader" method="POST" enctype="multipart/form-data">
               {% if session.display_warning %}
               <small class="form-text">Please check for the allowed extensions.</small>
               {% endif %}
               <center><input class="form-control-file" type="file" name="file" style="margin-bottom:4px"></input></center>
               <input class="btn btn-primary btn-space" type="submit" value="Upload" disabled />
               <small class="form-text text-muted">Allowed extensions: .mp3, .wav</small>
            </form>
            {% else %}
            <button id="harmonized_upload_link" onclick="harmonizeUpload();" class="btn btn-primary btn-xlarge">Harmonize Me!!</a> </button> <br>

            Uploaded: {% with messages = get_flashed_messages(category_filter=["name_display"]) %} {{ messages[0] }} {% endwith %}
            <form action="http://127.0.0.1:5000/reload">
               <input class="btn btn-info btn-space" type="submit" value="Upload another file" \>
<!--                <a id="harmonized_upload_link" href="{{ url_for('harmonizedResults') }}" class="btn btn-primary btn-xlarge">Harmonize Me!!</a>
 -->           
            </form>
            <script>
               var original_audio_buffer;
               $.get("/originalAudio", function(data) {
                  original_audio_buffer = data;
                  original_audio_buffer = new Float32Array(JSON.parse(original_audio_buffer));

                  //show waveform and its buttons
                  var wf = document.getElementById('waveform');
                  var pB = document.getElementById('playButton');
                  var p = document.getElementById('playRecordedInstructions');
                  wf.style.display = '';
                  pB.style.display = 'inline';
                  pB.nextElementSibling.style.display = 'inline';
                  pB.nextElementSibling.nextElementSibling.style.display = 'inline';
                  p.style.display = 'inline';
 
                  var arr = Array.prototype.slice.call(original_audio_buffer);
                  var dataview = encodeWAV(arr);
                  var audioBlob = new Blob([dataview], { type: 'audio/wav' });

                  wavesurfer.loadBlob(audioBlob);
                  wavesurfer.on('ready', function() {
                     console.log("WaveSurfer is ready to play.");
                     wavesurfer.on('finish', function() {
                        replay = true;
                        pB = document.getElementById("playButton");
                        rB = document.getElementById("recordButton");
                        // enable play button when finished
                        pB.disabled = false;
                        // disable pause and stop button when finished
                        pB.nextElementSibling.disabled = true;
                        pB.nextElementSibling.nextElementSibling.disabled = true;
                        // enable rerecording
                        rB.disabled = false;
                     });
                  });
               });
            </script>
            <br>
            {% endif %}
         </div>

         <!-- TESTING UPLOADING END -->
         <div id="replayKey" style="text-align:center">
            <p align="center">If you need to re-listen to your key, click the button below:</p>
            <button class="btn btn-success btn-space" type="button" onclick="playKey(this)"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Replay key!</button>
            <button class="btn btn-success btn-space" type="button" onclick="stopKey(this)" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button>
         </div>
      </div>

      <div id="waveform"></div>
   </div>
   
   <!-- Moved recorder.js's logging from on the page to the console. -->
<!--    <h2>Recordings</h2>
   <ul id="recordingslist"></ul>
   
   <h2>Log</h2>
   <pre id="log"></pre> -->

   <script>
   // move to just console.log
   // function __log(e, data) {
   //    log.innerHTML += "\n" + e + " " + (data || '');
   // }

   var audio_context;
   var recorder;
   var bufferData;
   var tonic, mode;
   var curr_audio;
   var numChannels = 1;
   var sampleRate = 44100;
   var replay = false;
   var wavesurfer;
   var wf; //waveform
   var pB; //playButton
   var rB; //recordButton
   var p; // a paragraph
   var l; // harmonized_results_link
   var ull; //harmonized_upload_link
   var harmonized_clicked_once = false;
   var harmonized_upload_clicked_once = false;

   // to enable/disable 'Upload' button
   $(document).ready(
    function(){
        $('input:file').change(
            function(){
                if ($(this).val()) {
                    $('input:submit').attr('disabled',false);
                    // or, as has been pointed out elsewhere:
                    // $('input:submit').removeAttr('disabled'); 
                } 
            }
            );
    });

   function linkIsDisabled(classString) {
      return classString.slice(classString.length-9) === " disabled";
   }

   function startUserMedia(stream) {
      var input = audio_context.createMediaStreamSource(stream);
      console.log('__Media stream created.');

      // Uncomment if you want the audio to feedback directly
      //input.connect(audio_context.destination);
      //__log('Input connected to audio context destination.');
      
      recorder = new Recorder(input);
      console.log('__Recorder initialised.');
   }

   function startRecording(button) {
      replay = false;
      wavesurfer.empty();
      recorder && recorder.record();
      // disable Record button while recording
      button.disabled = true;
      button.innerHTML = '<span class="glyphicon glyphicon-record" aria-hidden="true"></span> Recording...';
      // enable Pause button while recording
      button.nextElementSibling.disabled = false;
      // enable Stop button while recording
      button.nextElementSibling.nextElementSibling.disabled = false;
      // disable Harmonize button while recording
      if (!linkIsDisabled(l.className)) {
         l.className = l.className + " disabled";
      }
      pB.disabled = true;
      console.log('__Recording...');
   }

   function pauseRecording(button) {
      recorder && recorder.stop();
      // enable Record button while paused
      button.previousElementSibling.disabled = false;
      button.previousElementSibling.innerHTML = '<span class="glyphicon glyphicon-record" aria-hidden="true"></span> Record';
      // disable Pause button while paused
      button.disabled = true;
      // enable Stop button while paused
      button.nextElementSibling.disabled = false;
      // disable Harmonize button while paused
      if (!linkIsDisabled(l.className)) {
         l.className = l.className + " disabled";
      }  
      console.log('__Stopped recording.');
   }

   function stopRecording(button) {
      recorder && recorder.stop();
      // enable Record button while stopped
      button.previousElementSibling.previousElementSibling.disabled = false;
      button.previousElementSibling.previousElementSibling.innerHTML = '<span class="glyphicon glyphicon-record" aria-hidden="true"></span> Record';
      // disable Pause button while stopped
      button.previousElementSibling.disabled = true;
      // disable Stop button while stopped
      button.disabled = true;
      // enable Harmonize button ONLY while stopped
      if (linkIsDisabled(l.className)) {
         l.className = l.className.slice(0, l.className.length-9);
      }

      pB.disabled = false;
      console.log('__Stopped recording.');

      // get the buffer data, before clearing recorder's buffer
      recorder.getBuffer(function(data) {
         bufferData = data;
         //show waveform and its buttons
         var wf = document.getElementById('waveform');
         wf.style.display = '';
         pB.style.display = 'inline';
         pB.nextElementSibling.style.display = 'inline';
         pB.nextElementSibling.nextElementSibling.style.display = 'inline';
         p.style.display = 'inline';

         // BUFFERDATA HAS OTHER CHANNELS IN IT TOO. 
         var arr = Array.prototype.slice.call(bufferData[0]);
         var dataview = encodeWAV(arr);
         var audioBlob = new Blob([dataview], { type: 'audio/wav' });

         wavesurfer.loadBlob(audioBlob);
         wavesurfer.on('ready', function() {
            console.log("WaveSurfer is ready to play.");
            wavesurfer.on('finish', function() {
               replay = true;
               pB = document.getElementById("playButton");
               // enable play button when finished
               pB.disabled = false;
               // disable pause and stop button when finished
               pB.nextElementSibling.disabled = true;
               pB.nextElementSibling.nextElementSibling.disabled = true;
               // enable rerecording
               rB.disabled = false;
            });
         });
      });
      recorder.clear();

   }

   function play(button) {
      if (replay) {
         wavesurfer.stop();
         replay = false;
      }
      // disable Play button while playing
      button.disabled = true;
      // enable Pause button while playing
      button.nextElementSibling.disabled = false;
      // enable Stop button while playing
      button.nextElementSibling.nextElementSibling.disabled = false;
      // disable Record button while playing
      rB.disabled = true;
      wavesurfer.play();
   }

   function pause(button) {
      // enable Play button while paused
      button.previousElementSibling.disabled = false;
      // disable Pause button while paused
      button.disabled = true;
      // enable Stop button while paused
      button.nextElementSibling.disabled = false;

      wavesurfer.pause();
   }

   function stop(button) {
      // enable Play button while stopped
      button.previousElementSibling.previousElementSibling.disabled = false;
      // disable Pause button while stopped
      button.previousElementSibling.disabled = true;
      // disable Stop button while stopped
      button.disabled = true;
      // enable Record button while stopped
      rB.disabled = false;
      wavesurfer.stop();
   }

   function printBufferData(button) {
      console.log(bufferData);
   }
 
   function playKey(button) {
      button.disabled = true;
      button.nextElementSibling.disabled = false;

      var mode_string = "Major";
      if (mode === 1) {
         mode_string = "Minor";
      }
      var file_name = tonic.toString() + mode_string + "mid.mp3";
      var html_audio = document.getElementById(file_name);

      if (curr_audio != null) { // not null, something is playing
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = html_audio;
         curr_audio.play()
         curr_audio.onended = function() {
            curr_audio = null;
         };
      }
      else { // nothing is playing
            curr_audio = html_audio;
            curr_audio.play();
            curr_audio.onended = function() {
               curr_audio = null;
         };
      }
   }

   function stopKey(button) {
      button.disabled = true;
      button.previousElementSibling.disabled = false;
      if (curr_audio != null) {
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = null;
      }
   }

   /*
    * recorder.js internal functions to help successfully create the blob to load into
    * Before putting it into the blob, encode it correctly...
    */
    // helper for encodeWAV
   function writeString(view, offset, string) {
       for (var i = 0; i < string.length; i++) {
           view.setUint8(offset + i, string.charCodeAt(i));
       }
   }

   // helper for encodeWAV
   function floatTo16BitPCM(output, offset, input) {
       for (var i = 0; i < input.length; i++, offset += 2) {
           var s = Math.max(-1, Math.min(1, input[i]));
           output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
       }
   }

   // helper for exportWAV
   function encodeWAV(samples) {
      var buffer = new ArrayBuffer(44 + samples.length * 2);
      var view = new DataView(buffer);

      /* RIFF identifier */
      writeString(view, 0, 'RIFF');
      /* RIFF chunk length */
      view.setUint32(4, 36 + samples.length * 2, true);
      /* RIFF type */
      writeString(view, 8, 'WAVE');
      /* format chunk identifier */
      writeString(view, 12, 'fmt ');
      /* format chunk length */
      view.setUint32(16, 16, true);
      /* sample format (raw) */
      view.setUint16(20, 1, true);
      /* channel count */
      view.setUint16(22, numChannels, true);
      /* sample rate */
      view.setUint32(24, sampleRate, true);
      /* byte rate (sample rate * block align) */
      view.setUint32(28, sampleRate * 4, true);
      /* block align (channel count * bytes per sample) */
      view.setUint16(32, numChannels * 2, true);
      /* bits per sample */
      view.setUint16(34, 16, true);
      /* data chunk identifier */
      writeString(view, 36, 'data');
      /* data chunk length */
      view.setUint32(40, samples.length * 2, true);

      floatTo16BitPCM(view, 44, samples);

      return view;
   }

   function initWaveSurfer() {
      wavesurfer = WaveSurfer.create({
         container: '#waveform',
         scrollParent: true
      });
   }

   function harmonizeUpload() {
      ull = document.getElementById('harmonized_upload_link');
      if (!harmonized_upload_clicked_once)
      {
         ull.innerHTML = "Harmonizing now...";
         dummy = "blah";
         dummyData = "";
         $.post("/harmonizeUploaded", dummy, function(data) {
            dummyData = data;
         });
      }
      window.location.href = "{{ url_for('harmonizedResults') }}";
      harmonized_upload_clicked_once = true;
   }

   window.onload = function init() {
      console.log("Console messages starting with __ signify logging from the recorder");

      // hide WaveSurfer and its buttons at first
      wf = document.getElementById('waveform');
      wf.style.display = 'none';
      pB = document.getElementById('playButton');
      p = document.getElementById('playRecordedInstructions');
      rB = document.getElementById('recordButton');
      l = document.getElementById('harmonized_results_link');

      // getting tonic and mode from previous page
      $.get("/keyData", function(data) {
         var return_data = data.split(',');
         tonic = parseInt(return_data[0]);
         mode = parseInt(return_data[1]);
      });

      initWaveSurfer();

      // link listener; needs to post processed audio onto server before moving onto the next page
      var harmonized_results_link = document.getElementById("harmonized_results_link");


      harmonized_results_link.onclick = function() {
         // to avoid having multiple clicks to it make it blow up, but to also not completely disable the link.
         if (!harmonized_clicked_once)
         {
            l.innerHTML = "Harmonizing now...";
            strData = bufferData.toString();
            newData = ""
            $.post("/harmonizeData", strData, function(data) {
               newData = data;
               var newFloatData = new Float32Array(JSON.parse(newData));
               var newChannelData = [];
               newChannelData.push(newFloatData);

               // clear before it gives it new data
               recorder.clear();
               
               //recorder.setBuffer(newChannelData);
            });
         }
         harmonized_clicked_once = true;

      }

      try {
         // webkit shim
         window.AudioContext = window.AudioContext || window.webkitAudioContext;
         navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
         window.URL = window.URL || window.webkitURL;
         
         audio_context = new AudioContext;
         console.log('__Audio context set up.');
         console.log('__navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
      } catch (e) {
         alert('No web audio support in this browser!');
      }
      
      navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
         console.log('__No live audio input: ' + e);
      });
   };

// *** createDownloadLink() is obsolete since we made a download link in the next page.
// but, better not erase it since it was helpful
   // function createDownloadLink() {
   //    recorder && recorder.exportWAV(function(blob) {
   //       var url = URL.createObjectURL(blob);
   //       var li = document.createElement('li');
   //       var au = document.createElement('audio');
   //       var hf = document.createElement('a');
         
   //       au.controls = true;
   //       au.src = url;
   //       hf.href = url;
   //       hf.download = new Date().toISOString() + '.wav';
   //       hf.innerHTML = hf.download;
   //       li.appendChild(au);
   //       li.appendChild(hf);
   //       recordingslist.appendChild(li);
   //    });
   // }
   </script>


</body>
</html>
