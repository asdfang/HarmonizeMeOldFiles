<!DOCTYPE html>

<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>Sing and Harmonize!</title>
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" type="text/css" href="../static/bootstrap-3.3.7-dist/css/bootstrap.min.css">

      <!-- Custom CSS -->
      <!-- For Flask usage:
      <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/record.css') }}"></link> -->

      <!-- For local testing: -->
      <link rel="stylesheet" type="text/css" href="../static/css/record.css"></link>

      <!-- Custom fonts from Google-->
      <link href="https://fonts.googleapis.com/css?family=Lato|Lora|Merriweather|Montserrat" rel="stylesheet">

      <!-- Bootstrap and jQuery -->
      <script src="/static/jquery-3.2.1.min.js"></script>
      <script src="../static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

      <!-- wavesurfer.js -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.0.52/wavesurfer.min.js"></script>

      <!-- recorder.js -->
      <script src="/static/dist/recorder.js"></script>
   </head>
<body>
   <div id="audio_list">
         <!-- audio tonic files -->
         <audio id="60Majorhigh.mp3" src="./resources/60Majorhigh.mp3" preload="auto"></audio>
         <audio id="60Majormid.mp3"  src="./resources/60Majormid.mp3" preload="auto"></audio>
         <audio id="60Minorhigh.mp3" src="./resources/60Minorhigh.mp3" preload="auto"></audio>
         <audio id="60Minormid.mp3"  src="./resources/60Minormid.mp3" preload="auto"></audio>

         <audio id="61Majorhigh.mp3" src="./resources/61Majorhigh.mp3" preload="auto"></audio>
         <audio id="61Majormid.mp3"  src="./resources/61Majormid.mp3" preload="auto"></audio>
         <audio id="61Minorhigh.mp3" src="./resources/61Minorhigh.mp3" preload="auto"></audio>
         <audio id="61Minormid.mp3"  src="./resources/61Minormid.mp3" preload="auto"></audio>

         <audio id="62Majorhigh.mp3" src="./resources/62Majorhigh.mp3" preload="auto"></audio>
         <audio id="62Majormid.mp3"  src="./resources/62Majormid.mp3" preload="auto"></audio>
         <audio id="62Minorhigh.mp3" src="./resources/62Minorhigh.mp3" preload="auto"></audio>
         <audio id="62Minormid.mp3"  src="./resources/62Minormid.mp3" preload="auto"></audio>

         <audio id="63Majorhigh.mp3" src="./resources/63Majorhigh.mp3" preload="auto"></audio>
         <audio id="63Majormid.mp3"  src="./resources/63Majormid.mp3" preload="auto"></audio>
         <audio id="63Majorlow.mp3"  src="./resources/63Majorlow.mp3" preload="auto"></audio>
         <audio id="63Minorhigh.mp3" src="./resources/63Minorhigh.mp3" preload="auto"></audio>
         <audio id="63Minormid.mp3"  src="./resources/63Minormid.mp3" preload="auto"></audio>
         <audio id="63Minorlow.mp3"  src="./resources/63Minorlow.mp3" preload="auto"></audio>

         <audio id="64Majorhigh.mp3" src="./resources/64Majorhigh.mp3" preload="auto"></audio>
         <audio id="64Majormid.mp3"  src="./resources/64Majormid.mp3" preload="auto"></audio>
         <audio id="64Majorlow.mp3"  src="./resources/64Majorlow.mp3" preload="auto"></audio>
         <audio id="64Minorhigh.mp3" src="./resources/64Minorhigh.mp3" preload="auto"></audio>
         <audio id="64Minormid.mp3"  src="./resources/64Minormid.mp3" preload="auto"></audio>
         <audio id="64Minorlow.mp3"  src="./resources/64Minorlow.mp3" preload="auto"></audio>

         <audio id="65Majorhigh.mp3" src="./resources/65Majorhigh.mp3" preload="auto"></audio>
         <audio id="65Majormid.mp3"  src="./resources/65Majormid.mp3" preload="auto"></audio>
         <audio id="65Majorlow.mp3"  src="./resources/65Majorlow.mp3" preload="auto"></audio>
         <audio id="65Minorhigh.mp3" src="./resources/65Minorhigh.mp3" preload="auto"></audio>
         <audio id="65Minormid.mp3"  src="./resources/65Minormid.mp3" preload="auto"></audio>
         <audio id="65Minorlow.mp3"  src="./resources/65Minorlow.mp3" preload="auto"></audio>

         <audio id="66Majorhigh.mp3" src="./resources/66Majorhigh.mp3" preload="auto"></audio>
         <audio id="66Majormid.mp3"  src="./resources/66Majormid.mp3" preload="auto"></audio>
         <audio id="66Majorlow.mp3"  src="./resources/66Majorlow.mp3" preload="auto"></audio>
         <audio id="66Minorhigh.mp3" src="./resources/66Minorhigh.mp3" preload="auto"></audio>
         <audio id="66Minormid.mp3"  src="./resources/66Minormid.mp3" preload="auto"></audio>
         <audio id="66Minorlow.mp3"  src="./resources/66Minorlow.mp3" preload="auto"></audio>

         <audio id="67Majorhigh.mp3" src="./resources/67Majorhigh.mp3" preload="auto"></audio>
         <audio id="67Majormid.mp3"  src="./resources/67Majormid.mp3" preload="auto"></audio>
         <audio id="67Majorlow.mp3"  src="./resources/67Majorlow.mp3" preload="auto"></audio>
         <audio id="67Minorhigh.mp3" src="./resources/67Minorhigh.mp3" preload="auto"></audio>
         <audio id="67Minormid.mp3"  src="./resources/67Minormid.mp3" preload="auto"></audio>
         <audio id="67Minorlow.mp3"  src="./resources/67Minorlow.mp3" preload="auto"></audio>

         <audio id="68Majorhigh.mp3" src="./resources/68Majorhigh.mp3" preload="auto"></audio>
         <audio id="68Majormid.mp3"  src="./resources/68Majormid.mp3" preload="auto"></audio>
         <audio id="68Majorlow.mp3"  src="./resources/68Majorlow.mp3" preload="auto"></audio>
         <audio id="68Minorhigh.mp3" src="./resources/68Minorhigh.mp3" preload="auto"></audio>
         <audio id="68Minormid.mp3"  src="./resources/68Minormid.mp3" preload="auto"></audio>
         <audio id="68Minorlow.mp3"  src="./resources/68Minorlow.mp3" preload="auto"></audio>

         <audio id="69Majorhigh.mp3" src="./resources/69Majorhigh.mp3" preload="auto"></audio>
         <audio id="69Majormid.mp3"  src="./resources/69Majormid.mp3" preload="auto"></audio>
         <audio id="69Majorlow.mp3"  src="./resources/69Majorlow.mp3" preload="auto"></audio>
         <audio id="69Minorhigh.mp3" src="./resources/69Minorhigh.mp3" preload="auto"></audio>
         <audio id="69Minormid.mp3"  src="./resources/69Minormid.mp3" preload="auto"></audio>
         <audio id="69Minorlow.mp3"  src="./resources/69Minorlow.mp3" preload="auto"></audio>

         <audio id="70Majorlow.mp3"  src="./resources/70Majorlow.mp3" preload="auto"></audio>
         <audio id="70Majormid.mp3"  src="./resources/70Majormid.mp3" preload="auto"></audio>
         <audio id="70Minorlow.mp3"  src="./resources/70Minorlow.mp3" preload="auto"></audio>
         <audio id="70Minormid.mp3"  src="./resources/70Minormid.mp3" preload="auto"></audio>

         <audio id="71Majorlow.mp3"  src="./resources/71Majorlow.mp3" preload="auto"></audio>
         <audio id="71Majormid.mp3"  src="./resources/71Majormid.mp3" preload="auto"></audio>
         <audio id="71Minorlow.mp3"  src="./resources/71Minorlow.mp3" preload="auto"></audio>
         <audio id="71Minormid.mp3"  src="./resources/71Minormid.mp3" preload="auto"></audio>
      </div>

   <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-header">
         <a href="#" class="navbar-brand"><span class="glyphicon glyphicon-music" aria-hidden="true"></span> HarmonizeMe</a>
      </div>
   </nav>


   <div class="container">
      <div id="instructions" class="container">
         <div class="row">
            <div class="col-xs-3 num"><span class="instr">3.</span></div><div class="col-xs-9 instr"><span class="instr"><i>Upload</i> your singing!</span></div>
         </div>
      </div>

      <div class="jumbotron">
         <h3 style="text-align:center;">Instructions:</h3>
         <p style="font-size:16px; text-align:center;">
            Upload your singing, and adjust the key if you would like! <br>
            Make sure your singing and key match as best as you can.
         </p> 

         <div id="waveform"></div> <br>
         <div style="text-align:center">
            <button id="playButton" class="btn btn-info btn-space" onclick="play(this);" style="display:none"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Play</button>
            <button class="btn btn-info btn-space" onclick="pause(this);" style="display:none" disabled><span class="glyphicon glyphicon-pause" aria-hidden="true"></span> Pause</button>
            <button class="btn btn-info btn-space" onclick="stop(this);" style="display:none" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button>
         </div>

         <br>
         <div class="form-group" id="upload" style="text-align:center">
            {% if not session.file_uploaded %}
            <form action="http://127.0.0.1:5000/uploader" method="POST" enctype="multipart/form-data">
               {% if session.display_warning %}
               <small class="form-text">Please check for the allowed extensions.</small>
               {% endif %}
               <center><input class="form-control-file" type="file" name="file" style="margin-bottom:4px"></input></center>
               <input class="btn btn-primary btn-space" type="submit" value="Upload" disabled />
               <small class="form-text text-muted">Allowed extensions: .mp3, .wav</small>
            </form>
            {% else %}
            <button id="harmonized_upload_link" onclick="harmonizeUpload();" class="btn btn-primary btn-xlarge">Harmonize Me!!</a> </button> <br>

            Uploaded: {% with messages = get_flashed_messages(category_filter=["name_display"]) %} {{ messages[0] }} {% endwith %}
            <form action="http://127.0.0.1:5000/reload">
               <input class="btn btn-info btn-space" type="submit" value="Upload another file" \>
            </form>
            <script>
               var original_audio_buffer;
               $.get("/originalAudio", function(data) {
                  original_audio_buffer = data;
                  original_audio_buffer = new Float32Array(JSON.parse(original_audio_buffer));

                  //show waveform and its buttons
                  var wf = document.getElementById('waveform');
                  var pB = document.getElementById('playButton');
                  wf.style.display = '';
                  pB.style.display = 'inline';
                  pB.nextElementSibling.style.display = 'inline';
                  pB.nextElementSibling.nextElementSibling.style.display = 'inline';
 
                  var arr = Array.prototype.slice.call(original_audio_buffer);
                  var dataview = encodeWAV(arr);
                  var audioBlob = new Blob([dataview], { type: 'audio/wav' });

                  wavesurfer.loadBlob(audioBlob);
                  wavesurfer.on('ready', function() {
                     console.log("WaveSurfer is ready to play.");
                     wavesurfer.on('finish', function() {
                        replay = true;
                        pB = document.getElementById("playButton");
                        // enable play button when finished
                        pB.disabled = false;
                        // disable pause and stop button when finished
                        pB.nextElementSibling.disabled = true;
                        pB.nextElementSibling.nextElementSibling.disabled = true;
                     });
                  });
               });
            </script>
            <br>
            {% endif %}
         </div>
         <br>
         <div id="adjust-key" style="text-align:center">
            <p align="center">If needed, adjust the key, and press the Harmonize Me button after uploading to confirm the key:</p>
<!--             <button class="btn btn-success btn-space" type="button" onclick="playKey(this)"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Replay key!</button>
            <button class="btn btn-success btn-space" type="button" onclick="stopKey(this)" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button> -->
            <table id="keypicker" align="center">
               <tr>
                  <td>
                     <div style="float:left; width:100px;" class="form-group">
                        <label for="tonic_picker">Select tonic:</label> <br>
                        <select id="tonic_picker" class="form-control" onchange="updateTonic(this.value)">
                           <option value="60">C</option> 
                           <option value="61">C&#x266f;/D&#x266d;</option>
                           <option value="62">D</option>
                           <option value="63">E&#x266d;</option>
                           <option value="64">E</option>
                           <option value="65">F</option>
                           <option value="66">F&#x266f;/G&#x266d;</option>
                           <option value="67">G</option>
                           <option value="68">G&#x266f;/A&#x266d;</option>
                           <option value="69">A</option>
                           <option value="70">B&#x266d;</option>
                           <option value="71">B</option>
                        </select>
                     </div>
                  </td>
                  <td>
                     <div style="float:left; width:100px;" class="form-group">
                        <label for="mode_picker">Select mode:</label> <br>
                        <select id="mode_picker" class="form-control" onchange="updateMode(this.value)">
                           <option value="0">Major</option> 
                           <option value="1">Minor</option>
                        </select>
                     </div>
                  </td>
                  <td>
                     <div style="float:left; text-align:center" class="form-group">
                        <br>
                        <button class="btn btn-success" type="button" onclick="playKey(this)"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> Play audio!</button>
                        <button class="btn btn-success" type="button" onclick="stopKey(this)" disabled><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> Stop</button>
                     </div>
                  </td>
               </tr>
            </table>
         </div>
      </div>

      <div id="waveform"></div>
   </div>

   <script>
   var audio_context;
   var recorder;
   var bufferData;
   var tonic, mode;
   var curr_audio;
   var numChannels = 1;
   var sampleRate = 44100;
   var replay = false;
   var wavesurfer;
   var wf; //waveform
   var pB; //playButton
   var p; // a paragraph
   var ull; //harmonized_upload_link
   var harmonized_clicked_once = false;
   var harmonized_upload_clicked_once = false;

   // to enable/disable 'Upload' button
   $(document).ready(
    function(){
        $('input:file').change(
            function(){
                if ($(this).val()) {
                    $('input:submit').attr('disabled',false);
                    // or, as has been pointed out elsewhere:
                    // $('input:submit').removeAttr('disabled'); 
                } 
            }
            );
    });

   function linkIsDisabled(classString) {
      return classString.slice(classString.length-9) === " disabled";
   }

   function play(button) {
      if (replay) {
         wavesurfer.stop();
         replay = false;
      }
      // disable Play button while playing
      button.disabled = true;
      // enable Pause button while playing
      button.nextElementSibling.disabled = false;
      // enable Stop button while playing
      button.nextElementSibling.nextElementSibling.disabled = false;
      // disable Record button while playing
      wavesurfer.play();
   }

   function pause(button) {
      // enable Play button while paused
      button.previousElementSibling.disabled = false;
      // disable Pause button while paused
      button.disabled = true;
      // enable Stop button while paused
      button.nextElementSibling.disabled = false;

      wavesurfer.pause();
   }

   function stop(button) {
      // enable Play button while stopped
      button.previousElementSibling.previousElementSibling.disabled = false;
      // disable Pause button while stopped
      button.previousElementSibling.disabled = true;
      // disable Stop button while stopped
      button.disabled = true;
      // enable Record button while stopped
      wavesurfer.stop();
   }

   function updateTonic(newTonic) {
      tonic = parseInt(newTonic);
   }

   function updateMode(newMode) {
      mode = parseInt(newMode);
   }
 
   function playKey(button) {
      button.disabled = true;
      button.nextElementSibling.disabled = false;

      var mode_string = "Major";
      if (mode === 1) {
         mode_string = "Minor";
      }
      var file_name = tonic.toString() + mode_string + "mid.mp3";
      var html_audio = document.getElementById(file_name);

      if (curr_audio != null) { // not null, something is playing
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = html_audio;
         curr_audio.play()
         curr_audio.onended = function() {
            curr_audio = null;
         };
      }
      else { // nothing is playing
            curr_audio = html_audio;
            curr_audio.play();
            curr_audio.onended = function() {
               curr_audio = null;
         };
      }
      curr_audio.onended = function() {
         curr_audio = null;
         // enable Play and disable Stop buttons when done
         button.disabled = false;
         button.nextElementSibling.disabled = true;
      };
   }

   function stopKey(button) {
      button.disabled = true;
      button.previousElementSibling.disabled = false;
      if (curr_audio != null) {
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = null;
      }
   }

   /*
    * recorder.js internal functions to help successfully create the blob to load into
    * Before putting it into the blob, encode it correctly...
    */
    // helper for encodeWAV
   function writeString(view, offset, string) {
       for (var i = 0; i < string.length; i++) {
           view.setUint8(offset + i, string.charCodeAt(i));
       }
   }

   // helper for encodeWAV
   function floatTo16BitPCM(output, offset, input) {
       for (var i = 0; i < input.length; i++, offset += 2) {
           var s = Math.max(-1, Math.min(1, input[i]));
           output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
       }
   }

   // helper for exportWAV
   function encodeWAV(samples) {
      var buffer = new ArrayBuffer(44 + samples.length * 2);
      var view = new DataView(buffer);

      /* RIFF identifier */
      writeString(view, 0, 'RIFF');
      /* RIFF chunk length */
      view.setUint32(4, 36 + samples.length * 2, true);
      /* RIFF type */
      writeString(view, 8, 'WAVE');
      /* format chunk identifier */
      writeString(view, 12, 'fmt ');
      /* format chunk length */
      view.setUint32(16, 16, true);
      /* sample format (raw) */
      view.setUint16(20, 1, true);
      /* channel count */
      view.setUint16(22, numChannels, true);
      /* sample rate */
      view.setUint32(24, sampleRate, true);
      /* byte rate (sample rate * block align) */
      view.setUint32(28, sampleRate * 4, true);
      /* block align (channel count * bytes per sample) */
      view.setUint16(32, numChannels * 2, true);
      /* bits per sample */
      view.setUint16(34, 16, true);
      /* data chunk identifier */
      writeString(view, 36, 'data');
      /* data chunk length */
      view.setUint32(40, samples.length * 2, true);

      floatTo16BitPCM(view, 44, samples);

      return view;
   }

   function initWaveSurfer() {
      wavesurfer = WaveSurfer.create({
         container: '#waveform',
         scrollParent: true
      });
   }

   function harmonizeUpload() {
      ull = document.getElementById('harmonized_upload_link');
      if (!harmonized_upload_clicked_once)
      {
         ull.innerHTML = "Harmonizing now...";
         dummy = "blah";
         dummyData = "";
         $.post("/harmonizeUploaded", dummy, function(data) {
            dummyData = data;
         });
            // key stuff
            var tonic_e = document.getElementById("tonic_picker");
            var mode_e = document.getElementById("mode_picker");

            // to send to Harmonizer.py
            var tonic = tonic_e.options[tonic_e.selectedIndex].value;
            var mode = mode_e.options[mode_e.selectedIndex].value;

            var key = [tonic, mode];
            var keyString = key.toString();

            $.post("/keyData", keyString, function(data) {
               console.log("new key data: " + data);
            });
      }
      window.location.href = "{{ url_for('harmonizedResults') }}";
      harmonized_upload_clicked_once = true;
   }

   window.onload = function init() {
      // hide WaveSurfer and its buttons at first
      wf = document.getElementById('waveform');
      wf.style.display = 'none';
      pB = document.getElementById('playButton');

      // getting tonic and mode from previous page
      $.get("/keyData", function(data) {
         var return_data = data.split(',');
         tonic = parseInt(return_data[0]);
         mode = parseInt(return_data[1]);

         // selecting default key data
         $("#tonic_picker").val(tonic.toString());
         $("#mode_picker").val(mode.toString());
      });

      initWaveSurfer();
   };
   </script>
</body>
</html>
